#!/bin/sh
# Phantom Vault Installer
# Usage: curl -fsSL https://phantomvault.riscent.com/install | sh
#
# This script detects your OS and architecture, downloads the correct
# phantom-vault binary, and installs it to /usr/local/bin.

set -e

# â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REPO="r-db/phantom-vault"
INSTALL_DIR="/usr/local/bin"
BINARY_NAME="phantom"

# â”€â”€â”€ Colors (disable if not a terminal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -t 1 ]; then
  GREEN='\033[0;32m'
  RED='\033[0;31m'
  YELLOW='\033[0;33m'
  CYAN='\033[0;36m'
  BOLD='\033[1m'
  DIM='\033[2m'
  NC='\033[0m'
else
  GREEN='' RED='' YELLOW='' CYAN='' BOLD='' DIM='' NC=''
fi

# â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info()    { printf "${CYAN}  âœ“${NC} %s\n" "$1"; }
warn()    { printf "${YELLOW}  âš ${NC} %s\n" "$1"; }
error()   { printf "${RED}  âœ—${NC} %s\n" "$1"; exit 1; }
step()    { printf "\n${BOLD}  %s${NC}\n" "$1"; }

# â”€â”€â”€ Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
printf "\n"
printf "${BOLD}  â¬‡  Phantom Vault Installer${NC}\n"
printf "${DIM}  Secrets exist but are never observable.${NC}\n"

# â”€â”€â”€ Detect OS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
step "Detecting system..."

OS="$(uname -s)"
ARCH="$(uname -m)"

case "$OS" in
  Darwin) OS_NAME="macOS"; OS_TARGET="apple-darwin" ;;
  Linux)  OS_NAME="Linux"; OS_TARGET="unknown-linux-gnu" ;;
  *)      error "Unsupported operating system: $OS. Phantom Vault supports macOS and Linux." ;;
esac

case "$ARCH" in
  x86_64|amd64)   ARCH_TARGET="x86_64" ;;
  arm64|aarch64)   ARCH_TARGET="aarch64" ;;
  *)               error "Unsupported architecture: $ARCH. Phantom Vault supports x86_64 and arm64." ;;
esac

# Friendly names for display
case "$OS-$ARCH" in
  Darwin-arm64)    FRIENDLY="macOS (Apple Silicon)" ;;
  Darwin-x86_64)   FRIENDLY="macOS (Intel)" ;;
  Linux-x86_64)    FRIENDLY="Linux (x86_64)" ;;
  Linux-aarch64)   FRIENDLY="Linux (ARM64)" ;;
  *)               FRIENDLY="$OS_NAME ($ARCH)" ;;
esac

# Detect OS version
if [ "$OS" = "Darwin" ]; then
  OS_VERSION="$(sw_vers -productVersion 2>/dev/null || echo 'unknown')"
  info "$FRIENDLY â€” macOS $OS_VERSION"
elif [ "$OS" = "Linux" ]; then
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS_VERSION="${PRETTY_NAME:-Linux}"
  else
    OS_VERSION="Linux"
  fi
  info "$FRIENDLY â€” $OS_VERSION"
fi

# â”€â”€â”€ Check dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v curl >/dev/null 2>&1; then
  error "curl is required but not found. Install curl and try again."
fi

# â”€â”€â”€ Get latest release version â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
step "Finding latest version..."

LATEST_URL="https://api.github.com/repos/${REPO}/releases/latest"
VERSION="$(curl -fsSL "$LATEST_URL" 2>/dev/null | grep '"tag_name"' | head -1 | sed 's/.*"tag_name": *"//;s/".*//')"

if [ -z "$VERSION" ]; then
  warn "Could not detect latest version from GitHub."
  warn "Using fallback: v1.0.0"
  VERSION="v1.0.0"
fi

info "Latest version: $VERSION"

# â”€â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
step "Downloading phantom-vault ${VERSION} for ${ARCH_TARGET}-${OS_TARGET}..."

TMPDIR="$(mktemp -d)"

# Download phantom CLI
FILENAME="phantom-${ARCH_TARGET}-${OS_TARGET}"
DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${VERSION}/${FILENAME}"
TMPFILE="${TMPDIR}/${BINARY_NAME}"

HTTP_CODE="$(curl -fsSL -w "%{http_code}" -o "$TMPFILE" "$DOWNLOAD_URL" 2>/dev/null || true)"

if [ ! -f "$TMPFILE" ] || [ "$(wc -c < "$TMPFILE" | tr -d ' ')" -lt 1000 ]; then
  rm -rf "$TMPDIR"
  error "Download failed (HTTP $HTTP_CODE). Check https://github.com/${REPO}/releases for available builds."
fi

FILESIZE="$(wc -c < "$TMPFILE" | tr -d ' ')"
FILESIZE_MB="$(echo "scale=1; $FILESIZE / 1048576" | bc 2>/dev/null || echo "?")"
info "phantom CLI downloaded (${FILESIZE_MB} MB)"

chmod +x "$TMPFILE"

# Download vault-mcp (MCP server for Claude Code)
MCP_FILENAME="vault-mcp-${ARCH_TARGET}-${OS_TARGET}"
MCP_DOWNLOAD_URL="https://github.com/${REPO}/releases/download/${VERSION}/${MCP_FILENAME}"
MCP_TMPFILE="${TMPDIR}/vault-mcp"

HTTP_CODE="$(curl -fsSL -w "%{http_code}" -o "$MCP_TMPFILE" "$MCP_DOWNLOAD_URL" 2>/dev/null || true)"

if [ -f "$MCP_TMPFILE" ] && [ "$(wc -c < "$MCP_TMPFILE" | tr -d ' ')" -gt 1000 ]; then
  chmod +x "$MCP_TMPFILE"
  MCP_FILESIZE="$(wc -c < "$MCP_TMPFILE" | tr -d ' ')"
  MCP_FILESIZE_MB="$(echo "scale=1; $MCP_FILESIZE / 1048576" | bc 2>/dev/null || echo "?")"
  info "vault-mcp downloaded (${MCP_FILESIZE_MB} MB)"
  INSTALL_MCP=1
else
  warn "vault-mcp not available for this platform (Claude Code integration)"
  INSTALL_MCP=0
fi

# â”€â”€â”€ Verify binary runs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! "$TMPFILE" --version >/dev/null 2>&1; then
  rm -rf "$TMPDIR"
  error "Downloaded binary failed to execute. Your system may not be supported."
fi

INSTALLED_VERSION="$("$TMPFILE" --version 2>/dev/null || echo 'unknown')"

# â”€â”€â”€ Install â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
step "Installing to ${INSTALL_DIR}..."

if [ -w "$INSTALL_DIR" ]; then
  mv "$TMPFILE" "${INSTALL_DIR}/${BINARY_NAME}"
  [ "$INSTALL_MCP" = "1" ] && mv "$MCP_TMPFILE" "${INSTALL_DIR}/vault-mcp"
  info "Installed (no sudo needed)"
else
  if command -v sudo >/dev/null 2>&1; then
    printf "${DIM}  (requires sudo â€” enter your password)${NC}\n"
    sudo mv "$TMPFILE" "${INSTALL_DIR}/${BINARY_NAME}"
    [ "$INSTALL_MCP" = "1" ] && sudo mv "$MCP_TMPFILE" "${INSTALL_DIR}/vault-mcp"
    info "Installed"
  else
    rm -rf "$TMPDIR"
    error "Cannot write to ${INSTALL_DIR} and sudo is not available. Try: mv $TMPFILE ${INSTALL_DIR}/${BINARY_NAME}"
  fi
fi

rm -rf "$TMPDIR"

# â”€â”€â”€ Verify installation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
step "Verifying..."

if command -v phantom >/dev/null 2>&1; then
  info "$INSTALLED_VERSION"
else
  warn "phantom was installed to ${INSTALL_DIR} but is not in your PATH."
  warn "Add this to your shell profile:"
  printf "\n    export PATH=\"\$PATH:${INSTALL_DIR}\"\n\n"
fi

# â”€â”€â”€ Done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
printf "\n"
printf "${GREEN}${BOLD}  ğŸ” Phantom Vault is ready.${NC}\n"
printf "\n"
printf "  ${BOLD}Next steps:${NC}\n"
printf "    phantom init           Create your vault\n"
printf "    phantom add SECRET     Store your first API key\n"
printf "    phantom mcp install    Connect to Claude Code\n"
printf "    phantom --help         See all commands\n"
printf "\n"
printf "  ${DIM}Docs: https://phantomvault.riscent.com${NC}\n"
printf "  ${DIM}Source: https://github.com/${REPO}${NC}\n"
printf "\n"
